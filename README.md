# üì¶ –ë–æ—Ç ¬´–ò—Å–ø—Ä–∞–≤–∏—Ç–µ–ª—å¬ª

[![CI](https://github.com/HR25-HUB/Ispravitel_ek/actions/workflows/ci.yml/badge.svg?branch=main)](https://github.com/HR25-HUB/Ispravitel_ek/actions/workflows/ci.yml)
_–ë–µ–π–¥–∂ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ GitHub Actions —ç—Ç–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è._

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–æ—Ç –¥–ª—è —Å–≤–µ—Ä–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –º–µ–∂–¥—É 1–°-–ö–ê –∏ catalogApp.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç uv + ruff –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ –∏ –ª–∏–Ω—Ç–∏–Ω–≥–∞.

## üöÄ –ó–∞–ø—É—Å–∫
```bash
uv venv
uv pip install -r requirements.txt
python main.py
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Ä–µ–∂–∏–º—ã

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ `.env` (—Å–º. `.env.example`). –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

- `USE_MOCKS` ‚Äî –≤–∫–ª—é—á–∏—Ç—å –º–æ–∫–∏ (`1` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).
- `MOCK_PROFILE` ‚Äî –ø—Ä–æ—Ñ–∏–ª—å –º–æ–∫–∞: `happy | missing | conflict | errorrate10 | timeout`.
- `SEED` ‚Äî –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –º–æ–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `42`).
- `CATALOG_API_URL`, `CATALOG_API_KEY`, `CATALOG_ID` ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã, –µ—Å–ª–∏ `USE_MOCKS=0`.
- `CATALOG_TIMEOUT_SEC` ‚Äî —Ç–∞–π–º–∞—É—Ç HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ Catalog API –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `10.0`).
- `CATALOG_RETRIES` ‚Äî —á–∏—Å–ª–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ —Ç—Ä–∞–Ω–∑–∏–µ–Ω—Ç–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö/—Ç–∞–π–º–∞—É—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `3`).
- `CATALOG_BACKOFF_BASE_MS`, `CATALOG_BACKOFF_MAX_MS`, `CATALOG_BACKOFF_JITTER_MS` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–æ—Ñ—Ñ–∞ –º–µ–∂–¥—É —Ä–µ—Ç—Ä–∞—è–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º `CatalogAPI` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `100/2000/100` –º—Å).
- `STREAMLIT_PORT` ‚Äî –ø–æ—Ä—Ç UI (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `8501`).
- `LOG_LEVEL` ‚Äî `DEBUG|INFO|WARNING|ERROR|CRITICAL`.
- `CONFIDENCE_THRESHOLD` ‚Äî –ø–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ LLM-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ (0..1, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0.7`).
- `AGENT_SCHEDULE` ‚Äî –≤—Ä–µ–º—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∞–≥–µ–Ω—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `HH:MM` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `03:00`).
- `INPUT_PATH` ‚Äî –ø—É—Ç—å –∫ –≤—Ö–æ–¥–Ω–æ–º—É Excel-—Ñ–∞–π–ª—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `sample.xlsx`).
- `BACKOFF_BASE_MS`, `BACKOFF_MAX_MS`, `BACKOFF_JITTER_MS` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±—ç–∫–æ—Ñ—Ñ–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ä–µ—Ç—Ä–∞–µ–≤ –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ `main.py` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `100/2000/100` –º—Å).

–ü—Ä–∏–º–µ—Ä `.env` –¥–ª—è –º–æ–∫-—Ä–µ–∂–∏–º–∞:
```
USE_MOCKS=1
MOCK_PROFILE=happy
SEED=42
STREAMLIT_PORT=8501
LOG_LEVEL=INFO
AGENT_SCHEDULE=03:00
INPUT_PATH=sample.xlsx
```

–ü—Ä–∏–º–µ—Ä `.env` –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ (–ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è):
```
USE_MOCKS=0
CATALOG_API_URL=https://catalogapp/api
CATALOG_API_KEY=your_key
CATALOG_ID=your_catalog
LOG_LEVEL=INFO
```

## üß© DI –∏ –∫–ª–∏–µ–Ω—Ç—ã

- `services.get_catalog_client()` ‚Äî –∫–∞—Ç–∞–ª–æ–≥ (—Ä–µ–∞–ª—å–Ω—ã–π/–º–æ–∫ –ø–æ `USE_MOCKS`).
  - –í —Ä–µ–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä `CatalogAPI` –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è `CATALOG_TIMEOUT_SEC`, `CATALOG_RETRIES`, –∞ —Ç–∞–∫–∂–µ `CATALOG_BACKOFF_*`.
- `services.get_lcsc_client()` ‚Äî LCSC (–ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –º–æ–∫ `mocks/lcsc_mock.py`).
- `services.get_llm_client()` ‚Äî LLM (–ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –º–æ–∫ `mocks/llm_mock.py`).

–í –º–æ–∫-—Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `MOCK_PROFILE` (`happy|missing|conflict|errorrate10|timeout`) –∏ `SEED` –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞.
–ü—Ä–æ—Ñ–∏–ª—å `timeout` –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç `TimeoutError` –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤—ã–∑–æ–≤–∞—Ö (catalog: search/create/update; LCSC: search) ‚Äî —É–¥–æ–±–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.

## üîÅ –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Å–∫–µ–ª–µ—Ç)

–í `main.py` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ (–Ω–∞ –º–æ–∫–∞—Ö):

1. –ü–æ–∏—Å–∫ –≤ catalogApp (—Å —Ä–µ—Ç—Ä–∞—è–º–∏ ‚Äî –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö/—Ç–∞–π–º–∞—É—Ç–∞—Ö) —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –±—ç–∫–æ—Ñ—Ñ–æ–º –∏ –¥–∂–∏—Ç—Ç–µ—Ä–æ–º (—Å–º. `BACKOFF_*`).
2. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî fallback –∫ LCSC (—Ç–∞–∫–∂–µ —Å —Ä–µ—Ç—Ä–∞—è–º–∏ ‚Äî –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫).
3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è/–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è LLM; –ø—Ä–æ–≤–µ—Ä–∫–∞ `CONFIDENCE_THRESHOLD`.
4. –†–µ—à–µ–Ω–∏–µ: `create/update/skip/conflict`.
   - –ü—Ä–∏ `create`/`update` —Ç–∞–∫–∂–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ä–µ—Ç—Ä–∞–∏ (–¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫).
   - –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –≤ –∫–æ–ª–æ–Ω–∫–µ `errors` –∫–∞–∫ —Ç–µ–≥–∏ `step:ErrorType:attemptN`.

## üßπ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `import_excel.validate_input()` –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ `main.process_rows()` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π.

- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: `partnumber`.
  - –ü—É—Å—Ç–æ–µ/–ø—Ä–æ–±–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Üí —Å—Ç—Ä–æ–∫–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `skip`, `reason=invalid_input:missing_partnumber`.
- –î—É–±–ª–∏–∫–∞—Ç—ã `partnumber` –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ ‚Üí –≤—Å–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—Ö–æ–∂–¥–µ–Ω–∏—è –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `skip`, `reason=invalid_input:duplicate_partnumber`.
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –ø–æ–ª–µ: `brand`.
  - –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/–ø—É—Å—Ç–æ–µ ‚Üí —Å—Ç—Ä–æ–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∞–ª–∏–¥–Ω–æ–π, –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ `validation:missing_brand` (–≤ –∫–æ–ª–æ–Ω–∫–µ `warnings`).
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π: `partnumber`, `brand`, `gn`, `vn`, `external_id` –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è –∫ —Å—Ç—Ä–æ–∫–∞–º –∏ –æ—á–∏—â–∞—é—Ç—Å—è –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –ø–æ –∫—Ä–∞—è–º; `None/NaN` ‚Üí –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
- –ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ `warnings`/`errors` –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º `;`.

–î–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ –º–æ–∫–∞—Ö —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≥–Ω–∞—Ç—å —Ç–µ—Å—Ç—ã –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–±—Ä–∞–Ω–æ.

## üñ•Ô∏è UI (Streamlit)

```bash
uv venv
uv pip install -r requirements.txt
streamlit run ui_streamlit.py --server.port=${STREAMLIT_PORT:-8501}
```

## üß™ –¢–µ—Å—Ç—ã

```bash
pytest -q
```

## ‚è∞ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫/–ê–≥–µ–Ω—Ç

- –§–æ–Ω–æ–≤—ã–π –∞–≥–µ–Ω—Ç (`agent.py`) –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é, –∏—Å–ø–æ–ª—å–∑—É—è –±–∏–±–ª–∏–æ—Ç–µ–∫—É `schedule`.
- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—ë—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `AGENT_SCHEDULE` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"03:00"`).
- –ü—É—Ç—å –∫–æ –≤—Ö–æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `INPUT_PATH`. –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `sample.xlsx`.

–ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞:

```bash
python agent.py
```

–õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å –∏ –≤ —Ñ–∞–π–ª `logs/<run-id>.log`, —Ñ–æ—Ä–º–∞—Ç –∏ —É—Ä–æ–≤–µ–Ω—å —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è `LOG_LEVEL`.

## üìú –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å

- –ï–¥–∏–Ω—ã–π –ª–æ–≥–≥–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (`logger.init_logging`).
- –ö–∞–∂–¥–æ–º—É –∑–∞–ø—É—Å–∫—É –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è `run-id` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `run-20250828_205040-deadbeef`), –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É –ª–æ–≥–∞ –∏ –∏–º—è —Ñ–∞–π–ª–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
- –í—ã–≤–æ–¥ –≤ –¥–≤–∞ –º–µ—Å—Ç–∞:
  - –ö–æ–Ω—Å–æ–ª—å (stdout)
  - –§–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `logs/` —Å –∏–º–µ–Ω–µ–º `<run-id>.log`
- –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `LOG_LEVEL` (`DEBUG|INFO|WARNING|ERROR|CRITICAL`), —Å–º. `.env`.

## ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ

- Ruff (–ª–∏–Ω—Ç/—Ñ–æ—Ä–º–∞—Ç):
  ```bash
  ruff check .
  ruff format .
  ```
- Pre-commit (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ):
  ```bash
  pre-commit install
  pre-commit run --all-files
  ```

## üõ†Ô∏è CI (GitHub Actions)

–í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω CI (`.github/workflows/ci.yml`), –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ `push` –∏ `pull_request` –≤ –≤–µ—Ç–∫—É `main` –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
 
- –õ–∏–Ω—Ç –∏ —Ñ–æ—Ä–º–∞—Ç: `pre-commit` (–≤–∫–ª—é—á–∞–µ—Ç `ruff` –∏ `ruff-format`)
- –¢–µ—Å—Ç—ã: `pytest` (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ `pytest.ini`)
- –ö—ç—à Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ `actions/setup-python` (—É—Å–∫–æ—Ä—è–µ—Ç —Å–±–æ—Ä–∫—É)
 
–ë–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞ CI –æ—Ç–æ–±—Ä–∞–∂—ë–Ω –≤–≤–µ—Ä—Ö—É README.

## üîí –ü–æ–ª–∏—Ç–∏–∫–∞ PR/merge

- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `main` ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Pull Request.
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ merge:
  - –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ CI (–º–∞—Ç—Ä–∏—Ü–∞ Python: 3.11 –∏ 3.12).
  - –í–µ—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å up-to-date —Å `main` (rebase/merge –ø–µ—Ä–µ–¥ merge PR).
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 1 approval –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Å—É–∂–¥–µ–Ω–∏–π –≤ PR.
- –ü—Ä—è–º—ã–µ –ø—É—à–∏ –≤ `main` –∑–∞–ø—Ä–µ—â–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∑–∞—â–∏—Ç—ã –≤–µ—Ç–∫–∏.

## üìä –û—Ç—á–µ—Ç: –ø–æ–ª—è, —Ñ–æ—Ä–º–∞—Ç –∏ –º–µ—Ç—Ä–∏–∫–∏

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è Excel-–æ—Ç—á–µ—Ç (—Å–º. `reporter.save_report()`), —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –¥–≤–∞ –ª–∏—Å—Ç–∞:

- –õ–∏—Å—Ç `data` ‚Äî —Å–∞–º–∏ —Å—Ç—Ä–æ–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏, –≥–¥–µ –ø–µ—Ä–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ —É–ø–æ—Ä—è–¥–æ—á–µ–Ω—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∞–Ω–∞–ª–∏–∑–∞:

1. `external_id` ‚Äî –≤–Ω–µ—à–Ω–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (—Å–≤—è–∑–∫–∞ 1–°-–ö–ê ‚Üî PIM), –µ—Å–ª–∏ –µ—Å—Ç—å –≤–æ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
2. `partnumber` ‚Äî –∞—Ä—Ç–∏–∫—É–ª –∏–∑ 1–°-–ö–ê.
3. `brand` ‚Äî –±—Ä–µ–Ω–¥ –∏–∑ 1–°-–ö–ê –∏–ª–∏ –ø–æ–¥–æ–±—Ä–∞–Ω–Ω—ã–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ.
4. `gn` ‚Äî –≥—Ä—É–ø–ø–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã (–∏–∑ LLM-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏).
5. `vn` ‚Äî –≤–∏–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã (–∏–∑ LLM-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏).
6. `found_in_catalog` ‚Äî —Ñ–ª–∞–≥, –Ω–∞–π–¥–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä –≤ catalogApp (–ø–æ partnumber).
7. `action` ‚Äî –ø—Ä–∏–Ω—è—Ç–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: `create | update | skip | conflict | error`.
8. `status` ‚Äî –¥—É–±–ª–∏—Ä—É–µ—Ç `action` (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞).
9. `reason` ‚Äî –ø—Ä–∏—á–∏–Ω–∞ —Ä–µ—à–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `already_present`, `not_found`, `low_confidence`, `update_failed`).
10. `confidence` ‚Äî —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å LLM-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ (0..1), –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ.
11. `attrs_norm` ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã (JSON-—Å—Ç—Ä–æ–∫–∞). –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Äî –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
12. `errors` ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –ø–æ —à–∞–≥–∞–º –ø–∞–π–ø–ª–∞–π–Ω–∞ (—Ñ–æ—Ä–º–∞—Ç: `step:ErrorType[:attemptN]`, —á–µ—Ä–µ–∑ `;`).

- –õ–∏—Å—Ç `metrics` ‚Äî –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –æ—Ç—á–µ—Ç—É:
  - `total_rows`
  - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ `status`, `action`, `reason`

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:
- –ü–æ–ª–µ `attrs_norm` —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ JSON (UTF-8, `ensure_ascii=False`).
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤—Ö–æ–¥–Ω—ã–µ –ø–æ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ Excel) —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –æ—Ç—á–µ—Ç–µ –ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫.

## üê≥ Devcontainer/Docker

- –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å `.devcontainer/` –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–π —Å—Ä–µ–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.
- –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã `Dockerfile` –∏ `docker-compose.yml` —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏ `dev | prod | ui`.

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (Docker Compose)

1) –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥):

```bash
docker compose --profile dev up -d --build
```

2) –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–¥–æ–ø–æ–¥–æ–±–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (–±–µ–∑ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤):

```bash
docker compose --profile prod up -d --build
```

3) –ó–∞–ø—É—Å—Ç–∏—Ç—å UI (Streamlit):

```bash
docker compose --profile ui up -d --build
# –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:${STREAMLIT_PORT:-8501}
```

–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:

```bash
docker compose --profile dev down
docker compose --profile prod down
docker compose --profile ui down
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —Ç–∞–π–º‚Äë–∑–æ–Ω–∞

- –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ `.env` (—Å–º. —Ä–∞–∑–¥–µ–ª ¬´–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Ä–µ–∂–∏–º—ã¬ª).
- –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è cron –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `TZ` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `TZ=Europe/Moscow`).
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –Ω–µ–±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥ Python (`PYTHONUNBUFFERED=1`).

### üß™ Smoke‚Äë—Ç–µ—Å—Ç—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

–í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å –ø—Ä–æ—Å—Ç—ã–µ smoke‚Äë—Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–±–æ—Ä–∫–∏ –∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ Docker.

–ó–∞–ø—É—Å–∫ (PowerShell):

```powershell
$env:DOCKER_SMOKE=1
# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (—Å–µ–∫—É–Ω–¥—ã)
# $env:DOCKER_SMOKE_TIMEOUT=240

python -m pytest -q tests/test_container_smoke.py
```

–¢–µ—Å—Ç—ã –ø–æ–¥–Ω–∏–º–∞—é—Ç —Å–µ—Ä–≤–∏—Å—ã —Å –ø–æ–º–æ—â—å—é –ø—Ä–æ—Ñ–∏–ª–µ–π `prod` (`bot-prod`) –∏ `ui` (`ui`), –∂–¥—É—Ç `healthy` –ø–æ `healthcheck`, –∑–∞—Ç–µ–º –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –∏—Ö. –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `DOCKER_SMOKE` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, —Ç–µ—Å—Ç—ã –±—É–¥—É—Ç –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ `SKIPPED`.

–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≥—Ä–µ—Ç—å —Å–±–æ—Ä–∫—É –æ–±—Ä–∞–∑–æ–≤:

```bash
docker compose --profile prod build bot-prod
docker compose --profile ui build ui
```

### –õ–æ–≥–∏ –∏ –∑–¥–æ—Ä–æ–≤—å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

- –õ–æ–≥–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –ø–∏—à—É—Ç—Å—è –≤ stdout –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:

```bash
docker logs -f bot_ispravitel          # –ø—Ä–æ—Ñ–∏–ª—å dev
docker logs -f bot_ispravitel_prod     # –ø—Ä–æ—Ñ–∏–ª—å prod
```

- `healthcheck` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–ø—É—â–µ–Ω –ª–∏ cron. –°—Ç–∞—Ç—É—Å –≤–∏–¥–µ–Ω –≤ `docker ps`.


